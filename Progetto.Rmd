---
title: "Progetto HDDA AA2021/2022"
output: html_notebook
---


# Libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(data.table)
library(Hmisc)
library(dplyr)
library(corrplot)
library(lubridate)
library(stringr)
library(sampling)
`%notin%` <- Negate(`%in%`)
```

# Data Ingestion

```{r message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
acc <- fread("archive/accepted_2007_to_2018Q4.csv", sep = ",", header = T)
```

```{r, cache=TRUE}
variables <- c(
  "addr_state",
  "annual_inc",
  "application_type",
  "delinq_2yrs",
  "earliest_cr_line",
  "emp_length",
  "emp_title",
  "fico_range_high",
  "fico_range_low",
  "grade",
  "home_ownership",
  "initial_list_status",
  "int_rate",
  "issue_d",
  "loan_amnt",
  "loan_status",
  "mo_sin_old_il_acct",
  "mo_sin_old_rev_tl_op",
  "mort_acc",
  "num_bc_sats",
  "num_bc_tl",
  "num_op_rev_tl",
  "num_rev_accts",
  "num_rev_tl_bal_gt_0",
  "num_sats",
  "open_acc",
  "pct_tl_nvr_dlq",
  "percent_bc_gt_75",
  "pub_rec",
  "pub_rec_bankruptcies",
  "purpose",
  "revol_bal",
  "revol_util",
  "sub_grade",
  "tax_liens",
  "term",
  "total_acc",
  #"total_cu_tl",
  "verification_status"
)
```

```{r}
acc <- acc[,..variables]
acc <- acc[complete.cases(acc),]
acc <- acc[!apply(acc, 1, function(x) any(x=="")),]
```

```{r}
fwrite(acc, "archive/accepted_clean.csv", sep = ",")
```

```{r}
acc <- fread("archive/accepted_clean.csv", sep=",",header=T)
```

# Data Preparation


```{r}
acc <- as.data.frame(acc)
numeric_variables <- c(
  "annual_inc",
  "delinq_2yrs",
  "mo_sin_earliest_cr_line",
  "fico_range_high",
  "fico_range_low",
  "int_rate",
  "issue_d",
  "loan_amnt",
  "mo_sin_old_il_acct",
  "mo_sin_old_rev_tl_op",
  "mort_acc",
  "num_bc_sats",
  "num_bc_tl",
  "num_op_rev_tl",
  "num_rev_accts",
  "num_rev_tl_bal_gt_0",
  "num_sats",
  "open_acc",
  "pct_tl_nvr_dlq",
  "percent_bc_gt_75",
  "pub_rec",
  "pub_rec_bankruptcies",
  "revol_bal",
  "revol_util",
  "tax_liens",
  "total_acc"
)

acc <- acc %>%
  mutate(
    mo_sin_earliest_cr_line=as.integer(round((as.Date("2018-12-01")-lubridate::my(earliest_cr_line))/(365.25/12))),
    issue_d=as.integer(round((as.Date("2018-12-01")-lubridate::my(issue_d))/(365.25/12))),
    emp_length=as.numeric(str_extract(emp_length, "[0-9]+"))
  ) %>%
  mutate(
    emp_length = case_when(
      emp_length < 5 ~ "low",
      emp_length < 10 ~ "mid",
      T ~"high")) %>%
  select(-earliest_cr_line)
```

```{r}
acc_with_current <- acc
acc <- acc %>% 
  mutate(y=ifelse(loan_status == "Charged Off", "Default", loan_status)) %>%
  filter(loan_status %notin% c("Current", "In Grace Period", "Late (16-30 days)", "Late (31-120 days)"))
```

Possiamo pensare di utilizzare anche i Current tipo con 90% gi√† ripagato. Ma ci servono? No!

```{r}
describe(acc$loan_status)
```




# Data Exploration

### numero di osservazioni / tempo

```{r}
source("data_preparation/plot_osservazioni_e_tempo.R")
```

### Pie chart default vs fully paid

```{r}
source("data_preparation/pie_chart_default_VS_fully_paid.R")
```

### ROI boxplot/violinplot (for each grade?)

```{r}
source("data_preparation/ROI_violin.R")
```


### Violin plot for each numeric variable and barplot for categorical variables

```{r}
source("data_preparation/all_violin.R")
```


### Investigate correlations and fix


```{r}
corrplot(cor(acc[,numeric_variables]))
```

```{r}
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(acc[,numeric_variables])
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
png(filename = tempfile(pattern="file", tmpdir=tempdir(), fileext = "png"), width = 900, height = 900, type = "cairo")
corrplot::corrplot(cor(acc[,numeric_variables]), method="color", col=col(200),  
         type="upper", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, tl.cex = .7, number.cex=0.75,  #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.2, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=T 
         ) 
dev.off()
```

```{r}
ids <- sample(c(1:nrow(acc)), 8e4)
plot(acc[ids,"mo_sin_earliest_cr_line"], acc[ids,"mo_sin_old_rev_tl_op"])
```

```{r}
plot(acc[ids, "num_sats"], acc[ids, "open_acc"])
```

```{r}
acc <- acc %>% 
  mutate(fico_mean = (fico_range_high+fico_range_low)/2) %>%
  select(-fico_range_high, -fico_range_low)

### categorizzare fico_mean? https://www.investopedia.com/terms/f/ficoscore.asp

acc <- acc %>% 
  mutate(num_not_sats = open_acc - num_sats,
         num_bc_not_sats = num_bc_tl - num_bc_sats) %>%
  select(-num_sats, num_bc_sats)
```


```{r}
new_numeric_variables <- c(
  "annual_inc",
  "delinq_2yrs",
  "mo_sin_earliest_cr_line",
  "fico_mean",
  "int_rate",
  "issue_d",
  "loan_amnt",
  "mo_sin_old_il_acct",
  "mo_sin_old_rev_tl_op",
  "mort_acc",
  "num_bc_not_sats",
  "num_bc_tl",
  "num_op_rev_tl",
  "num_rev_accts",
  "num_rev_tl_bal_gt_0",
  "num_not_sats",
  "open_acc",
  "pct_tl_nvr_dlq",
  "percent_bc_gt_75",
  "pub_rec",
  "pub_rec_bankruptcies",
  "revol_bal",
  "revol_util",
  "tax_liens",
  "total_acc"
)
```


```{r}
corrplot(cor(acc[, new_numeric_variables]))
```

# Modeling

```{r}
balanced_acc <- acc %>% group_by(y) %>% sample_n(1e5) %>% ungroup()

train <- sample_frac(balanced_acc, 0.8)
test <- anti_join(balanced_acc,train)


fit <- glm(y~., train %>% select(-loan_status, -addr_state, -grade, -sub_grade, -emp_title) %>% mutate(y=ifelse(y=="Default",0,1)), family="binomial")

yhat <- predict(fit, test %>% select(-loan_status, -addr_state, -grade, -sub_grade, -emp_title))
ytest <- test$y

InformationValue::confusionMatrix(ytest, yhat)
```


```{r}
#PCA
library(factoextra)

pca.res <- prcomp(scale(as.matrix(acc[,new_numeric_variables])))
fviz_eig(pca.res)

print(pca.res$sdev)

acc_pca <- as.data.frame(scale(as.matrix(acc[,new_numeric_variables])) %*% pca.res$rotation)[,1:8]
#acc_pca <- acc_pca %>% cbind(acc %>% select(-new_numeric_variables))
acc_pca <- acc_pca %>% cbind(acc%>%select(y))
```


```{r}
balanced_acc <- acc_pca %>% group_by(y) %>% sample_n(1e5) %>% ungroup()

train <- sample_frac(balanced_acc, 0.8)
test <- anti_join(balanced_acc,train)

fit <- glm(y~., train %>% mutate(y=ifelse(y=="Default",0,1)), family="binomial")

yhat <- predict(fit, test )

ytest <- ifelse(test$y == "Default", 0, 1)

InformationValue::confusionMatrix(ytest, yhat)
```

```{r}
InformationValue::plotROC(ytest, yhat)
```



# Tuning



# Conclusions